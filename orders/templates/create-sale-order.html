{% extends 'master.html' %}
{% load static %}
{% load djmoney %}
{% load l10n %}
{% load i18n %}
{% block style %}
<style>
    .required {
        color: red;
    }

    .submit-row {
        display: display;
        padding: 12px 14px;
        margin: 0 0 20px;
        background: #f8f8f8;
        border: 1px solid #eee;
        border-radius: 4px;
        text-align: right;
        overflow: hidden;
    }

</style>
{% endblock style %}
{% block body%}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1>{{title}}</h1>

            <div class="text-zero top-right-button-container">
                <a href="{% url 'orders:list-so'%}">
                    <button type="button" class="btn btn-primary btn-lg top-right-button mr-1">BACK TO LIST</button>
                </a>
            </div>
            <div class="separator mb-5"></div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card">
            <div class="card-body">
                <form method="POST" id="myform" onsubmit="setFormSubmitting()">
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="form-group col-md-3">
                            <label>Customer</label>
                            {{so_form.customer}}
                        </div>
                        <div class="form-group col-md-3">
                            <label>{{so_form.sale_code.label}}</label>
                            {{so_form.sale_code}}
                        </div>
                        <div class="form-group col-md-3">
                            <label>Customer SO Number</label>
                            {{so_form.customer_so_number}}
                        </div>
                        <div class="form-group col-md-3">
                            <label>Date</label>
                            {{so_form.date}}
                        </div>
                        <div class="form-group col-md-3">
                            <label> Subtotal (EGP)</label>
                            {{so_form.subtotal_price}}
                        </div>


                        <div class="form-group col-md-3">
                            <label> Tax (EGP)</label>
                            {{so_form.tax_price}}
                        </div>

                        <div class="form-group col-md-3">
                            <label>Discount (EGP)</label>
                            {{so_form.discount_price }}
                        </div>

                        <div class="form-group col-md-3">
                            <label>Total (EGP)</label>
                            {{so_form.subtotal_after_shipping_cost}}
                        </div>

                        <div class="form-group col-md-3" style="display: none;">
                            <label>Global price after discount (EGP)</label>
                            {{so_form.my_total_price_after_discount}}
                        </div>


                        <div class="form-group col-md-3">
                            <label>Discount</label>
                            {{so_form.discount}}

                        </div>
                        <div class="form-group col-md-3">
                            <label>Discount Type</label>
                            {{so_form.discount_type}}
                        </div>

                        <div class="form-group col-md-3" onchange="Calculate_item_lines()">
                            <label>Apply Discount</label>
                            {{so_form.apply_discount}}
                        </div>


                        <div class="form-group col-md-3">
                            <label>Shipping Cost</label>
                            {{so_form.shipping_cost}}
                        </div>

<!--                        <button class="btn btn-lg col-md-2" type="button" onclick="apply()">Apply Shipping Cost</button>-->


                    </div>
                    <div class="separator mb-5"></div>
                    <div class="row" style="margin-left:0px;">
                        <div class="col-md-12">
                            <div class="bgc-white bd bdrs-3 p-20 mB-20">
                                <div id="purchase_set">
                                    <div class="form-row">
                                        <div class="form-group col-md-3">
                                            <label>{% trans "Item" %}</label>
                                        </div>
                                        <div class="form-group col-md-1">
                                            <label>{% trans "Location" %}</label>
                                        </div>
                                        <div class="form-group col-md-1">
                                            <label>{% trans "Quantity" %}</label>
                                        </div>
                                        <div class="form-group col-md-1">
                                            <label>{% trans "Unit" %}</label>
                                        </div>

                                        <div class="form-group col-md-1">
                                            <label>{% trans "Selling price per unit (EGP)" %}</label>
                                        </div>
                                        <div class="form-group col-md-2">
                                            <label>{% trans "Subtotal Price (EGP)" %}</label>
                                        </div>

                                        <div class="form-group col-md-1">
                                            <label>{% trans " Tax (EGP)" %}</label>
                                        </div>

                                        <div class="form-group col-md-1">
                                            <label>{% trans " Discount (EGP)" %}</label>
                                        </div>
                                        <div class="form-group col-md-1">
                                            <label>{% trans " Total (EGP)" %}</label>
                                        </div>

                                    </div>
                                    {{ so_transaction_inlineformset.management_form }}
                                    {% for form in so_transaction_inlineformset %}
                                    {{ form.id }}
                                    {{ form.media }}
                                    <div class="form-row">
                                        <div class="form-group col-md-3">
                                            {{form.item}}
                                        </div>
                                        <div class="form-group col-md-1">
                                            {{ form.location}}
                                        </div>
                                        <div class="form-group col-md-1">
                                            {{ form.quantity}}
                                        </div>
                                        <div class="form-group col-md-1">
                                            {{form.uom}}
                                        </div>

                                        <div class="form-group col-md-1">
                                            {{form.price_per_unit}}
                                        </div>
                                        <div class="form-group col-md-2">
                                            {{form.total_price}}
                                        </div>
                                        <div class="form-group col-md-1">
                                            {{form.item_tax}}
                                        </div>

                                        <div class="form-group col-md-1">
                                            {{form.item_descount}}
                                        </div>

                                        <div class="form-group col-md-1">
                                            {{form.total}}
                                        </div>


                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>


                    </div>


                    <button type="button" id="add_item" class="btn cur-p btn-success">{% trans "Add Inventory Item"%}
                    </button>
                    <div id="empty_form" style="display:none">
                        <table class='no_error'>
                            <div class="form-row">
                                {{ so_transaction_inlineformset.empty_form.media }}
                                <div class="form-group col-md-3">
                                    {{ so_transaction_inlineformset.empty_form.item}}
                                </div>
                                <div class="form-group col-md-1">
                                    {{ so_transaction_inlineformset.empty_form.location}}
                                </div>
                                <div class="form-group col-md-1">
                                    {{ so_transaction_inlineformset.empty_form.quantity}}
                                </div>
                                <div class="form-group col-md-1">
                                    {{ so_transaction_inlineformset.empty_form.uom}}
                                </div>

                                <div class="form-group col-md-1">
                                    {{ so_transaction_inlineformset.empty_form.price_per_unit }}
                                </div>
                                <div class="form-group col-md-2">
                                    {{ so_transaction_inlineformset.empty_form.total_price}}
                                </div>
                                <div class="form-group col-md-1">
                                    {{ so_transaction_inlineformset.empty_form.item_tax}}
                                </div>
                                <div class="form-group col-md-1">
                                    {{ so_transaction_inlineformset.empty_form.item_descount}}
                                </div>
                                <div class="form-group col-md-1">
                                    {{ so_transaction_inlineformset.empty_form.total}}
                                </div>


                            </div>
                        </table>
                    </div>

                    <div class="submit-row">
                        <button type="submit" class="btn btn-primary btn-lg mt-3" name='Save'>Save</button>
                        <button type="submit" class="btn btn-primary btn-lg mt-3" name='Save and exit'>Save and Exit
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock body %}

{% block js %}

<script>
    $('#myform').on('submit', function () {
        for (i = 0; i < $('#id_salestransaction_set-TOTAL_FORMS').val(); i++) {
            $('#id_salestransaction_set-' + i + '-total_price').prop('disabled', false);
            $('#id_salestransaction_set-' + i + '-item_descount').prop('disabled', false);
            $('#id_salestransaction_set-' + i + '-total').prop('disabled', false);
            $('#id_salestransaction_set-' + i + '-item_tax').prop('disabled', false);




        }
        $('#id_subtotal_price').prop('disabled', false);
        $('#id_tax_price').prop('disabled', false);
        $('#id_my_total_price_after_discount').prop('disabled', false);
        $('#id_discount_price').prop('disabled', false);
        $('#id_subtotal_after_shipping_cost').prop('disabled', false);

    });


</script>
<script>
    function myAction(object) {
        item = object.value
        var endpoint = '{% url "orders:get-item" -1 %}'.replace('-1', item);
        if (item !== "") {
            var str = object.id
            var res = str.split("-")
            var id_prefix = res[0] + '-' + res[1]
            price_id = id_prefix + '-' + 'price_per_unit'
            quantity_id = id_prefix + '-' + 'quantity'
            location_id = id_prefix + '-' + 'location'
            mylocation = document.getElementById(location_id).value
            $.ajax({
                type: "get",
                url: endpoint,
                contentType: 'application/json',
                success: function (data) {
                   uom_function(object)
                    if (mylocation !== "") {
                        var flag = false;
                        for (i = 0; i < data['balance'].length; i++) {
                            if (mylocation == data['balance'][i]['location']) {
                                flag = true;

                                document.getElementById(quantity_id).placeholder = data['balance'][i]['qnt'];
                            };
                        };
                        if (flag == false) {
                            document.getElementById(quantity_id).placeholder = "";

                        }
                    }
                    else {
                        document.getElementById(quantity_id).placeholder = "";

                    }
                    if (document.getElementById(quantity_id).value) {
                        myFunction(document.getElementById(quantity_id));
                    };


                },
                error: function () {
                    alert("error");
                }
            });

        };

    };


</script>

<script>
    function myFunction(object) {

        var str = object.id;
        var res = str.split("-");
        var id_prefix = res[0] + '-' + res[1];
        item_id = id_prefix + '-' + 'item';
        price_id = id_prefix + '-' + 'price_per_unit';
        subtotal_price_id = id_prefix + '-' + 'total_price';
        quantity_id = id_prefix + '-' + 'quantity';
        item_tax_id = id_prefix + '-' + 'item_tax'
        item_total_id = id_prefix + '-' + 'total'
        quantity = document.getElementById(quantity_id).value;
        item = document.getElementById(item_id).value;
        price = document.getElementById(price_id).value;
        price = document.getElementById(price_id).value;

        if (price) {

            var total_per_item = price * quantity;
            document.getElementById(subtotal_price_id).value = total_per_item;
            tex_amount = total_per_item * {{tax}}
            document.getElementById(item_tax_id).value = (tex_amount.toFixed(1))
            document.getElementById(item_total_id).value =(total_per_item).toFixed(1);

            Calculate_item_lines();


        };

        };


</script>
<script>
    $('#add_item').click(function () {
        var form_idx = $('#id_salestransaction_set-TOTAL_FORMS').val();
        $('#purchase_set').append($('#empty_form').html().replace(/__prefix__/g, form_idx));
        $('#id_salestransaction_set-TOTAL_FORMS').val(parseInt(form_idx) + 1);
        var current_indx = Number(form_idx)





    });


</script>
<script>
    function inventory(object) {
        var str = object.id;
        var res = str.split("-");
        var id_prefix = res[0] + '-' + res[1];
        item_id = id_prefix + '-' + 'item';
        quantity_id = id_prefix + '-' + 'quantity'
        price_id = id_prefix + '-' + 'temp_unit_cost'
        item = document.getElementById(item_id).value;

        if (item !== "") {
            var endpoint = '{% url "orders:get-item" -1 %}'.replace('-1', item);
            $.ajax({
                type: "get",
                url: endpoint,
                contentType: 'application/json',
                success: function (data) {
                    var flag = false;
                    for (i = 0; i < data['balance'].length; i++) {
                        if (object.value == data['balance'][i]['location']) {
                            flag = true;
                            document.getElementById(quantity_id).placeholder = data['balance'][i]['qnt'];

                        };
                    };
                    if (flag == false) {
                        document.getElementById(quantity_id).placeholder = '';
                        document.getElementById(price_id).value = '';
                    };



                },
                error: function () {
                    alert("error");
                }
            });

        };

    };


</script>
<script>
    var formSubmitting = false;
    var setFormSubmitting = function () { formSubmitting = true; console.log("ENTEREERERD"); };

    window.onload = function () {
        window.addEventListener("beforeunload", function (e) {
            if (formSubmitting) {
                return undefined;
            }

            var confirmationMessage = 'It looks like you have been editing something. '
                + 'If you leave before saving, your changes will be lost.';

            (e || window.event).returnValue = confirmationMessage; //Gecko + IE
            return confirmationMessage; //Gecko + Webkit, Safari, Chrome etc.
        });
    };

</script>

<script>
    function calculate_so_subtotal(){
        var item_subtotals = document.getElementsByClassName("unique-class");
        var subtotal = 0;
        for (i = 0; i < item_subtotals.length; i++) {
          if (item_subtotals[i].value){
            subtotal = subtotal + Number(item_subtotals[i].value);
            }
         }
         return subtotal
    }
</script>
<script>

    function calculate_so_tax() {
        subtotal = calculate_so_subtotal()
        tax = Number({{ tax }});
        tax_price = tax * subtotal
        return Number(tax_price)
    }

</script>
<script>
    function calculate_so_discount() {
        subtotal_price = calculate_so_subtotal();
        tax = calculate_so_tax()
        total = Number(subtotal_price) + Number(tax)
        discount = document.getElementById("id_discount").value;
        discount_percentage = Number(discount ) / 100
        discount_price = Number(total)  *  Number(discount_percentage)
        return discount_price
    }

</script>

<script>
    function grandTotal() {
        subtotal = calculate_so_subtotal()
        let discount_amount = 0;
        let shipping_cost=0
        tax_amount = calculate_so_tax()
        if (document.getElementById("id_discount").value){
            discount_amount = calculate_so_discount()
            document.getElementById("id_discount_price").value = discount_amount.toFixed(2);

        }
        if (document.getElementById("id_shipping_cost").value){
             shipping_cost = Number(document.getElementById("id_shipping_cost").value);
        }
        grand_total = subtotal + tax_amount - discount_amount + shipping_cost
        document.getElementById("id_subtotal_price").value =subtotal.toFixed(2)
        document.getElementById("id_tax_price").value = tax_amount.toFixed(2);
        document.getElementById("id_subtotal_after_shipping_cost").value = grand_total;

}

</script>

<script>
    function Calculate_item_lines() {
        var item_lines = document.getElementsByClassName("unique-class");
        for (i = 0; i < item_lines.length; i++) {
            if (item_lines[i].value) {   // if the item has a total calculated value
                var str = item_lines[i].id;
                var res = str.split("-");
                var id_prefix = res[0] + '-' + res[1];
                item_discount_id = id_prefix + '-' + 'item_descount'
                item_total_id = id_prefix + '-' + 'total'
                price_id = id_prefix + '-' + 'price_per_unit'
                quantity_id = id_prefix + '-' + 'quantity'
                item_tax_id = id_prefix + '-' + 'item_tax'
                unit_price = document.getElementById(price_id).value
                quantity = document.getElementById(quantity_id).value
                subtotal_price = unit_price * quantity
                item_tax_amount = item_tax(item_lines[i])
                item_after_tax = subtotal_price + item_tax_amount;
                item_discount_amount = item_discount(item_lines[i]);
                item_total_after_discount = item_after_tax - item_discount_amount
                if (document.getElementById("id_apply_discount").checked){
                    document.getElementById(item_discount_id).value =(item_discount_amount).toFixed(1);
                    document.getElementById(item_total_id).value =(item_total_after_discount).toFixed(1);
                }
                else{
                    document.getElementById(item_total_id).value =(item_after_tax).toFixed(1);
                    document.getElementById(item_discount_id).value =0;
                    }

            }


        }
            grandTotal();

    }
</script>
<script>
    function item_discount(item){
            var res = item.id.split("-");
            var id_prefix = res[0] + '-' + res[1];
            price_id = id_prefix + '-' + 'price_per_unit'
            quantity_id = id_prefix + '-' + 'quantity'
            unit_price = document.getElementById(price_id).value
            quantity = document.getElementById(quantity_id).value
            subtotal_price = unit_price * quantity
            tax_amount = item_tax(item)
            subtotal_after_tax = subtotal_price +tax_amount
            discount_percentage = document.getElementById('id_discount').value;
            item_total_discount_amount = discount_percentage * subtotal_after_tax / 100;
            return item_total_discount_amount

        };




</script>
<script>
    function item_tax(item){
        var res = item.id.split("-");
        var id_prefix = res[0] + '-' + res[1];
        price_id = id_prefix + '-' + 'price_per_unit'
        quantity_id = id_prefix + '-' + 'quantity'
        item_tax_id = id_prefix + '-' + 'item_tax'
        unit_price = document.getElementById(price_id).value
        quantity = document.getElementById(quantity_id).value
        subtotal_price = unit_price * quantity
        tax_amount = subtotal_price * {{tax}}
        return tax_amount;

    }

</script>
<script>
    function uom_function(object) {
        console.log("i got inside the function ")
        var url = "{% url 'orders:ajax_load_uoms' %}"  // get the url of the `load_cities` view
        var itemId = object.value;  // get the selected country ID from the HTML input
        var str = object.id
        var res = str.split("-")
        var id_prefix = res[0] + '-' + res[1]
        myuom_id = id_prefix + '-' + 'uom'

        $.ajax({                       // initialize an AJAX request
            url: url,                    // set the url of the request (= localhost:8000/hr/ajax/load-cities/)
            data: {
                'item': itemId     // add the country id to the GET parameters
            },
            success: function (data) {   // `data` is the return of the `load_cities` view function
                document.getElementById(myuom_id).innerHTML = data;  // replace the contents of the city input with the data that came from the server

            }
        });

    };
</script>


{% endblock js %}